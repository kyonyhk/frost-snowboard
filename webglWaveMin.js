const PARTICLES_X=250,PARTICLES_Y=150,TOTAL_PARTICLES=PARTICLES_X*PARTICLES_Y,TWO_PI=2*Math.PI;let scene,camera,renderer,particleSystem,animationId,mouse,raycaster;function initializeParticleSystem(){if("undefined"==typeof THREE)return void console.error("THREE.js is not loaded. Please ensure it is included before this script.");cleanupResources(),scene=new THREE.Scene,camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3),scene.background=new THREE.Color(396808);const e=document.querySelector(".hero_webgl-element");if(!e)return void console.error("Canvas element not found");renderer=new THREE.WebGLRenderer({canvas:e}),renderer.setSize(window.innerWidth,window.innerHeight),window.addEventListener("resize",onWindowResize);const t=createCircleTexture(128,"#6BE688");particleSystem=setupParticleSystem(scene,t),camera.position.z=120,mouse=new THREE.Vector2,raycaster=new THREE.Raycaster,document.addEventListener("mousemove",onDocumentMouseMove),animate(),setupScrollTrigger(e,stopAnimation,startAnimation)}function cleanupResources(){animationId&&(cancelAnimationFrame(animationId),animationId=null),renderer&&renderer.dispose(),scene&&scene.clear(),window.removeEventListener("resize",onWindowResize),document.removeEventListener("mousemove",onDocumentMouseMove)}function onWindowResize(){camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight)}function onDocumentMouseMove(e){mouse.x=e.clientX/window.innerWidth*2-1,mouse.y=-e.clientY/window.innerHeight*2+1}function animate(){animationId=requestAnimationFrame(animate),updateParticles(particleSystem,raycaster,mouse,camera),renderer.render(scene,camera)}function stopAnimation(){animationId&&(cancelAnimationFrame(animationId),animationId=null)}function startAnimation(){animationId||animate()}function createCircleTexture(e,t){const n=2*e,i=document.createElement("canvas");i.width=i.height=n;const r=i.getContext("2d");r.beginPath(),r.arc(e,e,e,0,TWO_PI,!1),r.fillStyle=t,r.fill();const o=new THREE.Texture(i);return o.needsUpdate=!0,o}function setupParticleSystem(e,t){const n=new THREE.BufferGeometry,i=new Float32Array(3*TOTAL_PARTICLES),r=new Float32Array(TOTAL_PARTICLES),o=new Float32Array(TOTAL_PARTICLES);for(let e=0;e<PARTICLES_X;e++)for(let t=0;t<PARTICLES_Y;t++){const n=e*PARTICLES_Y+t,a=2*(e-PARTICLES_X/2),s=2*(t-PARTICLES_Y/2);i[3*n]=a,i[3*n+1]=s,i[3*n+2]=0,r[n]=1,o[n]=.5}n.setAttribute("position",new THREE.BufferAttribute(i,3)),n.setAttribute("scale",new THREE.BufferAttribute(r,1)),n.setAttribute("opacity",new THREE.BufferAttribute(o,1));const a=new THREE.ShaderMaterial({uniforms:{color:{value:new THREE.Color(16777215)},pointTexture:{value:t}},vertexShader:vertexShader(),fragmentShader:fragmentShader(),depthTest:!1,transparent:!0}),s=new THREE.Points(n,a);return e.add(s),s}function updateParticles(e,t,n,i){const r=e.geometry.attributes.position.array,o=e.geometry.attributes.scale.array,a=e.geometry.attributes.opacity.array;t.setFromCamera(n,i);const s=t.intersectObject(e),c=.005*Date.now();for(let e=0;e<TOTAL_PARTICLES;e++){const t=3*e,n=r[t],i=r[t+1];r[t+2]=10*Math.sin(.1*c+.07*n)+30*Math.sin(.1*c+.01*i)+7*Math.cos(.5*c+.01*n);let l=1,d=.5;if(s.length>0){const e=Math.hypot(n-s[0].point.x,i-s[0].point.y);e<10&&(l=1+(10-e)/10*1.5,d=1-e/10*.5)}o[e]=l,a[e]=d}e.geometry.attributes.position.needsUpdate=!0,e.geometry.attributes.scale.needsUpdate=!0,e.geometry.attributes.opacity.needsUpdate=!0}function setupScrollTrigger(e,t,n){ScrollTrigger.create({trigger:".section.is-collections-main",start:"bottom bottom",end:"bottom 80%",onLeave:()=>{t(),e.style.display="none"},onEnterBack:()=>{e.style.display="block",n()}})}function vertexShader(){return"\n    attribute float scale;\n    attribute float opacity;\n    varying vec2 vUv;\n    varying float vOpacity;\n    void main() {\n      vUv = uv;\n      vOpacity = opacity;\n      vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);\n      gl_PointSize = scale * (300.0 / -mvPosition.z);\n      gl_Position = projectionMatrix * mvPosition;\n    }\n  "}function fragmentShader(){return"\n    uniform vec3 color;\n    uniform sampler2D pointTexture;\n    varying vec2 vUv;\n    varying float vOpacity;\n    void main() {\n      gl_FragColor = vec4(color, vOpacity) * texture2D(pointTexture, gl_PointCoord);\n    }\n  "}function reinitializeParticleSystem(){console.log("Reinitializing particle system"),cleanupResources(),initializeParticleSystem()}gsap.registerPlugin(ScrollTrigger),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initializeParticleSystem):initializeParticleSystem(),window.addEventListener("popstate",(e=>{"/"===window.location.pathname&&reinitializeParticleSystem()}));
